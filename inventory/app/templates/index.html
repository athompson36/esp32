{% extends "base.html" %}
{% block content %}
  <nav class="tabs" role="tablist" aria-label="Main sections">
    <button type="button" class="tab-btn active" role="tab" id="tab-btn-search" data-tab="search" aria-selected="true">Search</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-settings" data-tab="settings" aria-selected="false">AI settings</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-docker" data-tab="docker" aria-selected="false">Docker &amp; tools</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-workspace" data-tab="workspace" aria-selected="false">Workspace</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-flash" data-tab="flash" aria-selected="false">Backup / Flash</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-device-config" data-tab="device-config" aria-selected="false">Device config</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-debug" data-tab="debug" aria-selected="false">Debug</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-projects" data-tab="projects" aria-selected="false">Project planning</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-inventory" data-tab="inventory" aria-selected="false">Inventory</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-setup-help" data-tab="setup-help" aria-selected="false">Setup help</button>
    <button type="button" class="tab-btn" role="tab" id="tab-btn-add-device" data-tab="add-device" aria-selected="false">Add device</button>
  </nav>

  <div class="tab-panels">
  <section class="tab-panel active" id="panel-search" role="tabpanel" aria-labelledby="tab-btn-search">
  <section class="toolbar">
    <div class="search-row">
      <input type="text" id="search" placeholder="Search name, part number, tags‚Ä¶" autocomplete="off">
      <select id="category">
        <option value="">All categories</option>
      </select>
      <button type="button" id="btn-search">Search</button>
    </div>
    <div class="ai-row">
      <div class="ai-input-wrap">
        <input type="text" id="ai-query" placeholder="Ask: e.g. What do I have for MIDI? Teensy boards? 5V parts?" autocomplete="off">
        <button type="button" id="btn-ai-voice" class="btn-voice" title="Voice input" aria-label="Voice input">üé§</button>
      </div>
      <button type="button" id="btn-ai">AI query</button>
      <div id="ai-answer" class="ai-answer" aria-live="polite"></div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-settings" role="tabpanel" aria-labelledby="tab-btn-settings" hidden>
  <section class="settings-section" id="settings-section">
    <div class="settings-heading-row">
      <h2 class="settings-heading">AI API settings</h2>
      <button type="button" id="btn-settings-save" class="btn-refresh">Save</button>
    </div>
    <p class="settings-note">OpenAI-compatible API: used for AI query, project planning, setup help, and add-device wizard. Works with OpenAI, Azure OpenAI, or any proxy that speaks the OpenAI API (set Base URL). Key can also be set via <code>OPENAI_API_KEY</code> (env overrides file). Stored in <code>artifacts/ai_settings.json</code>.</p>
    <div class="settings-status-block" id="settings-ai-status-block" aria-live="polite">
      <span class="settings-status-label">AI API connection:</span>
      <span id="settings-ai-connection-status" class="settings-status-badge">‚Äî</span>
      <span id="settings-ai-connection-message" class="settings-status-message"></span>
    </div>
    <div class="settings-fields">
      <div class="settings-row">
        <label for="settings-api-key">API key</label>
        <span id="settings-api-key-status" class="settings-status">‚Äî</span>
        <input type="password" id="settings-api-key" placeholder="Enter key to set or change; leave blank to keep" autocomplete="off">
      </div>
      <div class="settings-row">
        <label for="settings-model">Model</label>
        <input type="text" id="settings-model" placeholder="gpt-4o-mini" autocomplete="off" title="e.g. gpt-4o-mini, gpt-4o, or your provider's model id">
      </div>
      <div class="settings-row">
        <label for="settings-base-url">Base URL</label>
        <input type="text" id="settings-base-url" placeholder="Optional: e.g. https://api.openai.com/v1 or proxy URL" autocomplete="off">
      </div>
    </div>
    <span id="settings-save-status" class="flash-status"></span>
  </section>
  <section class="settings-section settings-paths-section" id="settings-paths-section">
    <div class="settings-heading-row">
      <h2 class="settings-heading">Paths</h2>
      <button type="button" id="btn-settings-paths-save" class="btn-refresh">Save paths</button>
    </div>
    <p class="settings-note">Docker container (name or ID) and paths used by the app and MCP. When running in Docker, repo is mounted at <code>/workspace</code>; defaults below match that. Stored in <code>artifacts/path_settings.json</code>. Database path is applied on next app start.</p>
    <div class="settings-status-block settings-paths-status-block" id="settings-paths-status-block" aria-live="polite">
      <div class="settings-path-status-row">
        <span class="settings-status-label">Docker:</span>
        <span id="settings-docker-status-badge" class="settings-status-badge">‚Äî</span>
        <span id="settings-docker-status-message" class="settings-status-message"></span>
      </div>
      <div class="settings-path-status-row">
        <span class="settings-status-label">Frontend:</span>
        <span id="settings-frontend-status-badge" class="settings-status-badge">‚Äî</span>
      </div>
      <div class="settings-path-status-row">
        <span class="settings-status-label">Backend:</span>
        <span id="settings-backend-status-badge" class="settings-status-badge">‚Äî</span>
      </div>
      <div class="settings-path-status-row">
        <span class="settings-status-label">Database:</span>
        <span id="settings-database-status-badge" class="settings-status-badge">‚Äî</span>
      </div>
      <div class="settings-path-status-row">
        <span class="settings-status-label">MCP server:</span>
        <span id="settings-mcp-status-badge" class="settings-status-badge">‚Äî</span>
      </div>
    </div>
    <div class="settings-fields">
      <div class="settings-row">
        <label for="settings-docker-container">Docker container</label>
        <input type="text" id="settings-docker-container" placeholder="e.g. cyber-lab-mcp or container ID" autocomplete="off">
      </div>
      <div class="settings-row">
        <label for="settings-frontend-path">Frontend path</label>
        <input type="text" id="settings-frontend-path" placeholder="e.g. /workspace (repo root in Docker) or local repo path" autocomplete="off">
      </div>
      <div class="settings-row">
        <label for="settings-backend-path">Backend path</label>
        <input type="text" id="settings-backend-path" placeholder="e.g. /workspace/inventory/app (this app in Docker)" autocomplete="off">
      </div>
      <div class="settings-row">
        <label for="settings-database-path">Database path</label>
        <input type="text" id="settings-database-path" placeholder="e.g. /workspace/inventory/inventory.db" autocomplete="off">
      </div>
      <div class="settings-row">
        <label for="settings-mcp-server-path">MCP server path</label>
        <input type="text" id="settings-mcp-server-path" placeholder="e.g. /workspace/mcp-server" autocomplete="off">
      </div>
    </div>
    <span id="settings-paths-save-status" class="flash-status"></span>
  </section>
  </section>

  <section class="tab-panel" id="panel-docker" role="tabpanel" aria-labelledby="tab-btn-docker" hidden>
  <section class="docker-section" id="docker-section">
    <div class="docker-heading-row">
      <h2 class="docker-heading">Docker &amp; tools</h2>
      <button type="button" id="btn-docker-refresh" class="btn-refresh">Refresh</button>
    </div>
    <div class="docker-status" id="docker-status">Checking‚Ä¶</div>
    <p class="docker-hint">If this app is running in a container, the host Docker daemon is not visible unless you mount the socket: <code>-v /var/run/docker.sock:/var/run/docker.sock</code> (and install Docker CLI in the image).</p>
    <div class="docker-containers-block">
      <h3 class="docker-subheading">Containers</h3>
      <p class="docker-containers-hint">Start, stop, or restart lab-related containers. Refresh after an action to see updated status.</p>
      <div class="docker-containers-actions">
        <button type="button" id="btn-docker-containers-refresh" class="btn-refresh">Refresh containers</button>
        <span id="docker-containers-message" class="flash-status"></span>
      </div>
      <div class="docker-containers-table-wrap">
        <table class="docker-containers-table" id="docker-containers-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Image</th>
              <th>State</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="docker-containers-tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="docker-tools" id="docker-tools"></div>
  </section>
  </section>

  <section class="tab-panel" id="panel-workspace" role="tabpanel" aria-labelledby="tab-btn-workspace" hidden>
  <section class="workspace-section" id="workspace-section">
    <div class="workspace-heading-row">
      <h2 class="workspace-heading">Workspace</h2>
      <div class="workspace-controls">
        <label for="workspace-camera">Camera</label>
        <select id="workspace-camera">
          <option value="0">Camera 0</option>
        </select>
        <button type="button" id="btn-workspace-refresh" class="btn-refresh">Refresh</button>
      </div>
    </div>
    <p class="workspace-note">Live view from the server webcam (4K USB recommended). Stream is from this app‚Äôs host; if the app runs in Docker, pass the device through (e.g. uncomment <code>devices: - /dev/video0</code> in <code>docker-compose.yml</code>, or <code>--device /dev/video0</code> when running the container).</p>
    <div class="workspace-layout">
      <div class="workspace-feed-col">
        <div class="workspace-feed-wrap">
          <img id="workspace-feed" class="workspace-feed" src="" alt="Workspace camera feed" crossorigin="anonymous">
          <div id="workspace-feed-placeholder" class="workspace-feed-placeholder" aria-live="polite">Loading‚Ä¶</div>
          <div id="workspace-feed-error" class="workspace-feed-error" hidden aria-live="polite"></div>
        </div>
      </div>
      <div class="workspace-chat-col">
        <div class="workspace-chat-panel">
          <div id="workspace-chat-messages" class="workspace-chat-messages" role="log" aria-live="polite"></div>
          <div class="workspace-chat-input-row">
            <input type="text" id="workspace-chat-input" class="workspace-chat-input" placeholder="Ask about objects or request step-by-step help‚Ä¶" autocomplete="off">
            <button type="button" id="workspace-chat-send" class="btn-refresh">Send</button>
          </div>
        </div>
      </div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-flash" role="tabpanel" aria-labelledby="tab-btn-flash" hidden>
  <section class="flash-section" id="flash-section">
    <div class="flash-heading-row">
      <h2 class="flash-heading">Backup / Restore / Flash</h2>
      <button type="button" id="btn-flash-refresh" class="btn-refresh">Refresh &amp; detect devices</button>
    </div>
    <div id="flash-docker-notice" class="flash-docker-notice" role="alert" hidden>
      <strong>Ports not available (app is running in Docker).</strong> To see your T-Beam and use Backup/Flash, run the app on your Mac from the repo root: <code>python inventory/app/app.py</code> then open <a href="http://127.0.0.1:5050" target="_blank" rel="noopener">http://127.0.0.1:5050</a>. Install esptool if needed: <code>pip install esptool</code>.
    </div>
    <p class="flash-note">All flashing is <strong>internal</strong> (this app, esptool) and <strong>launcher/firmware compatible</strong> based on your selection. Backup to .bin (full backup can take 10+ min), restore from .bin, or flash a build. Prefer <code>firmware.factory.bin</code> (or <em>merged</em>) for full flash at 0x0; app-only <code>firmware.bin</code> is written at 0x10000. From repo root, <code>./scripts/flash.sh</code> flashes latest artifact (same logic). Choose a <strong>Firmware target</strong> to filter artifacts (Meshtastic, MeshCore, Launcher). Click <strong>Refresh &amp; detect devices</strong> to auto-detect connected ESP32 boards (port and chip). Device must be connected via USB; <strong>esptool</strong> must be installed on the host. <strong>T-Beam 1W / ESP32-S3:</strong> if the board is not detected, put it in bootloader mode (hold BOOT, press RESET, release BOOT) then click Refresh again.</p>
    <p class="flash-note"><strong>T-Beam 1W MeshCore:</strong> Select <strong>firmware.factory.bin</strong> for a full bootable image (this UI only lists full images; bootloader/partitions are excluded). Flash uses <strong>qio 16MB</strong> for T-Beam 1W. If the board won‚Äôt boot after a previous flash, erase first (e.g. <code>ERASE=1 ./scripts/flash.sh ‚Ä¶</code> from repo root) then flash <strong>firmware.factory.bin</strong> again.</p>
    <p class="flash-note">To see <strong>live serial output</strong> from the device (e.g. after flashing), open the <strong>Debug</strong> tab, select the port, choose baud rate (115200 is typical), and click <strong>Start</strong>.</p>
    <div class="flash-sd-note" role="note">SD card: devices with an SD slot (e.g. T-Beam) are not backed up or restored through this interface. Remove the card and use host tools (e.g. disk image / dd) to image or restore the SD.</div>
    <div class="flash-controls">
      <div class="flash-row">
        <label for="flash-port">Port</label>
        <select id="flash-port">
          <option value="">‚Äî Select port ‚Äî</option>
        </select>
        <span id="flash-detect-status" class="flash-status" aria-live="polite"></span>
        <label for="flash-device">Device</label>
        <select id="flash-device">
          <option value="">‚Äî Select device ‚Äî</option>
        </select>
        <label for="flash-firmware-target">Firmware target</label>
        <select id="flash-firmware-target" title="Filter flash/restore file list by firmware family (internal, launcher compatible)">
          <option value="">All</option>
          <option value="meshtastic">Meshtastic</option>
          <option value="meshcore">MeshCore</option>
          <option value="launcher">Launcher</option>
        </select>
      </div>
      <div id="flash-uf2-notice" class="flash-uf2-notice" role="status" hidden>
        <strong>UF2 device.</strong> Backup, restore, and flash are not available in this app. Use the <strong>magnetic pogo cable</strong> and copy a UF2 file to the <strong>HT-n5262</strong> drive. See <a href="/api/devices/ht_mesh_pocket_10000/notes/FLASHING_UF2.md" target="_blank" rel="noopener">FLASHING_UF2.md</a>.
      </div>

      <section class="flash-build-section" id="flash-build-section" aria-labelledby="flash-build-heading">
        <h3 id="flash-build-heading" class="flash-build-heading">Firmware build</h3>
        <p class="flash-internal-note">Build from source with PlatformIO or ESP-IDF (lab-build.sh in container). Output is saved to artifacts and appears in the Flash list. For ESP-IDF (e.g. Lumari Watch) select env ‚Äúdefault‚Äù. Optionally flash to device after build.</p>
        <div class="flash-build-options">
          <div class="flash-row">
            <label for="flash-build-device">Device</label>
            <select id="flash-build-device">
              <option value="">‚Äî Select ‚Äî</option>
            </select>
            <label for="flash-build-firmware">Firmware</label>
            <select id="flash-build-firmware">
              <option value="">‚Äî Select ‚Äî</option>
            </select>
            <label for="flash-build-env">Env</label>
            <select id="flash-build-env">
              <option value="">‚Äî Select ‚Äî</option>
            </select>
          </div>
          <div class="flash-row flash-patches-row" id="flash-build-patches-row">
            <label>Patches (optional)</label>
            <div id="flash-build-patches" class="flash-patches-list" aria-describedby="flash-patches-note">‚Äî</div>
          </div>
          <p id="flash-patches-note" class="flash-internal-note">Select patches to apply before building. Applied in order; tree is reverted after build.</p>
          <div class="flash-row flash-build-opts-row">
            <label class="flash-check-label"><input type="checkbox" id="flash-build-clean" value="1"> Clean before build</label>
            <label class="flash-check-label"><input type="checkbox" id="flash-build-verbose" value="1"> Verbose</label>
            <label class="flash-check-label"><input type="checkbox" id="flash-build-flash-after" value="1"> Flash after build</label>
            <label for="flash-build-timeout">Timeout (s)</label>
            <input type="number" id="flash-build-timeout" class="flash-input flash-input-num" min="60" max="3600" value="300" title="Build timeout in seconds">
          </div>
          <div class="flash-row">
            <button type="button" id="btn-flash-build">Build</button>
            <span id="flash-build-status" class="flash-status"></span>
          </div>
        </div>
      </section>

      <div class="flash-actions">
        <div class="flash-action-block">
          <h3>Get release / OTA</h3>
          <p class="flash-internal-note">Download a .bin from a GitHub release (e.g. Meshtastic, MeshCore) into artifacts for flashing.</p>
          <div class="flash-row">
            <label for="flash-download-repo">Repo</label>
            <select id="flash-download-repo">
              <option value="">‚Äî Select ‚Äî</option>
              <option value="meshtastic/firmware">meshtastic/firmware</option>
              <option value="meshcore-dev/MeshCore">meshcore-dev/MeshCore</option>
            </select>
            <label for="flash-download-tag">Tag (blank = latest)</label>
            <input type="text" id="flash-download-tag" placeholder="latest" class="flash-input">
            <label for="flash-download-filter">Asset filter (e.g. tbeam)</label>
            <input type="text" id="flash-download-filter" placeholder="tbeam" class="flash-input">
            <button type="button" id="btn-flash-download">Download</button>
          </div>
          <span id="flash-download-status" class="flash-status"></span>
        </div>
        <div class="flash-action-block">
          <h3>Backup</h3>
          <div class="flash-row">
            <select id="flash-backup-type">
              <option value="full">Full flash</option>
              <option value="app">App partition (0x10000)</option>
              <option value="nvs">NVS (0x9000)</option>
            </select>
            <label for="flash-backup-name">Name (optional)</label>
            <input type="text" id="flash-backup-name" class="flash-input" placeholder="e.g. before-upgrade" autocomplete="off" title="Custom filename for this backup (saved in artifacts/backups)">
            <button type="button" id="btn-flash-backup">Backup</button>
          </div>
          <span id="flash-backup-status" class="flash-status"></span>
        </div>
        <div id="backup-progress-dialog" class="backup-progress-overlay" role="dialog" aria-modal="true" aria-labelledby="backup-progress-title" hidden>
          <div class="backup-progress-dialog">
            <h3 id="backup-progress-title">Backing up</h3>
            <p id="backup-progress-message">Reading flash. Full backup can take several minutes.</p>
            <div class="backup-progress-bar-wrap" aria-hidden="true">
              <div class="backup-progress-bar"></div>
            </div>
          </div>
        </div>
        <div class="flash-action-block">
          <h3>Restore</h3>
          <select id="flash-restore-file">
            <option value="">‚Äî Select file or upload ‚Äî</option>
          </select>
          <input type="file" id="flash-restore-upload" accept=".bin" style="display:none">
          <button type="button" id="btn-flash-restore-choose">Upload .bin‚Ä¶</button>
          <button type="button" id="btn-flash-restore">Restore</button>
          <button type="button" id="btn-flash-delete-restore" class="btn-delete" title="Delete selected backup or firmware file from disk">Delete selected</button>
          <span id="flash-restore-status" class="flash-status"></span>
        </div>
        <div class="flash-action-block">
          <h3>Flash</h3>
          <p class="flash-internal-note">Internal flash only; file list filtered by Firmware target above.</p>
          <select id="flash-flash-file">
            <option value="">‚Äî Select file or upload ‚Äî</option>
          </select>
          <input type="file" id="flash-flash-upload" accept=".bin" style="display:none">
          <button type="button" id="btn-flash-flash-choose">Upload .bin‚Ä¶</button>
          <button type="button" id="btn-flash-flash">Flash</button>
          <button type="button" id="btn-flash-delete-flash" class="btn-delete" title="Delete selected backup or firmware file from disk">Delete selected</button>
          <span id="flash-flash-status" class="flash-status"></span>
        </div>
      </div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-projects" role="tabpanel" aria-labelledby="tab-btn-projects" hidden>
  <section class="projects-section" id="projects-section">
    <div class="projects-heading-row">
      <h2 class="projects-heading">Project planning</h2>
      <button type="button" id="btn-project-new" class="btn-refresh">New project</button>
    </div>
    <p class="projects-note">Develop an idea with the AI; it will suggest a BOM and, for circuits, pinouts, wiring, schematic notes, and enclosure/CAD notes. Export BOM for Digi-Key or Mouser; export pinout/wiring as CSV and schematic/enclosure as markdown for PCBs and 3D printing.</p>
    <div class="projects-controls">
      <div class="projects-row">
        <label for="project-controller">Controller</label>
        <select id="project-controller">
          <option value="">‚Äî Select ‚Äî</option>
        </select>
        <label for="project-select">Saved project</label>
        <select id="project-select">
          <option value="">‚Äî New or select ‚Äî</option>
        </select>
      </div>
      <div class="project-templates-wrap" id="project-templates-wrap" hidden>
        <h3 class="project-templates-heading">Common templates</h3>
        <div id="project-templates-list" class="project-templates-list"></div>
      </div>
      <div class="project-editor" id="project-editor">
        <div class="project-meta">
          <input type="text" id="project-title" placeholder="Project title">
          <textarea id="project-description" placeholder="Description / idea (optional)" rows="2"></textarea>
        </div>
        <div class="project-chat">
          <h3>Develop with AI</h3>
          <div id="project-messages" class="project-messages"></div>
          <div class="project-chat-input">
            <input type="text" id="project-message" placeholder="Describe your idea or ask for parts‚Ä¶" autocomplete="off">
            <button type="button" id="btn-project-voice" class="btn-voice" title="Voice input" aria-label="Voice input">üé§</button>
            <button type="button" id="btn-project-send">Send</button>
          </div>
        </div>
        <div class="project-bom">
          <h3>Parts BOM</h3>
          <div class="project-bom-actions">
            <button type="button" id="btn-project-check-inv">Check inventory</button>
            <a id="btn-bom-digikey" href="#" class="btn-link" download="bom_digikey.csv">Export for Digi-Key</a>
            <a id="btn-bom-mouser" href="#" class="btn-link" download="bom_mouser.csv">Export for Mouser</a>
            <span id="project-cost-summary" class="project-cost-summary" aria-live="polite"></span>
          </div>
          <div class="project-bom-table-wrap">
            <table class="project-bom-table" id="project-bom-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Part #</th>
                  <th>Qty</th>
                  <th>Unit price</th>
                  <th>Line total</th>
                  <th>On hand</th>
                  <th>Shortfall</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="project-bom-tbody"></tbody>
            </table>
          </div>
        </div>
        <div class="project-hardware" id="project-hardware">
          <h3>Hardware design (pinouts, wiring, schematic, enclosure)</h3>
          <div class="project-hardware-grid">
            <div class="project-hardware-block">
              <h4>Pin out</h4>
              <div class="project-hardware-actions">
                <a id="btn-export-pinout" href="#" class="btn-link" download="pinout.csv">Export CSV</a>
              </div>
              <div class="project-bom-table-wrap">
                <table class="project-bom-table" id="project-pinout-table">
                  <thead><tr><th>Pin</th><th>Function</th><th>Notes</th></tr></thead>
                  <tbody id="project-pinout-tbody"></tbody>
                </table>
              </div>
            </div>
            <div class="project-hardware-block">
              <h4>Wiring / netlist</h4>
              <div class="project-hardware-actions">
                <a id="btn-export-wiring" href="#" class="btn-link" download="wiring.csv">Export CSV</a>
              </div>
              <div class="project-bom-table-wrap">
                <table class="project-bom-table" id="project-wiring-table">
                  <thead><tr><th>From</th><th>To</th><th>Net</th></tr></thead>
                  <tbody id="project-wiring-tbody"></tbody>
                </table>
              </div>
            </div>
            <div class="project-hardware-block project-hardware-full">
              <h4>Schematic notes</h4>
              <div class="project-hardware-actions">
                <a id="btn-export-schematic" href="#" class="btn-link" download="schematic.md">Export .md</a>
              </div>
              <pre id="project-schematic-text" class="project-notes-pre"></pre>
            </div>
            <div class="project-hardware-block project-hardware-full">
              <h4>Enclosure / CAD (3D print)</h4>
              <div class="project-hardware-actions">
                <a id="btn-export-enclosure" href="#" class="btn-link" download="enclosure.md">Export .md</a>
              </div>
              <pre id="project-enclosure-text" class="project-notes-pre"></pre>
            </div>
            <div class="project-hardware-block project-hardware-full project-design-preview-block">
              <h4>PCB design preview</h4>
              <p class="project-preview-caption">Board outline and component placement from pinout and wiring. Export pinout/wiring as CSV for KiCad or other EDA.</p>
              <div class="project-preview-wrap project-preview-pcb-wrap">
                <canvas id="project-pcb-preview" class="project-preview-canvas" width="400" height="280" aria-label="PCB layout preview"></canvas>
              </div>
            </div>
            <div class="project-hardware-block project-hardware-full project-design-preview-block">
              <h4>3D print design preview</h4>
              <p class="project-preview-caption">Enclosure box from design notes (e.g. 80√ó60√ó30 mm). Drag to rotate, scroll to zoom.</p>
              <div class="project-preview-wrap project-preview-3d-wrap">
                <div id="project-3d-preview" class="project-preview-3d" aria-label="3D enclosure preview"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="project-save-row">
          <button type="button" id="btn-project-save">Save proposal</button>
          <span id="project-save-status" class="flash-status"></span>
        </div>
      </div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-device-config" role="tabpanel" aria-labelledby="tab-btn-device-config" hidden>
  <section class="device-config-section" id="device-config-section">
    <h2 class="device-config-heading">Device configuration wizard</h2>
    <p class="device-config-note">Guide through full device configuration, pre- or post-flash, for Meshtastic, MeshCore, or Launcher (internal or launcher compatible). Save presets and use the AI to assist at any step.</p>
    <div class="config-wizard-wrap">
      <div class="config-wizard-steps">
        <div id="config-wizard-step-indicator" class="config-wizard-step-indicator" aria-live="polite"></div>
        <div id="config-wizard-step-1" class="config-wizard-step" data-step="1">
          <h3>1. When to configure</h3>
          <div class="config-wizard-field">
            <label><input type="radio" name="config-when" value="pre" checked> Pre-flash ‚Äî set options first, then flash</label>
            <label><input type="radio" name="config-when" value="post"> Post-flash ‚Äî device already flashed, configure now</label>
          </div>
        </div>
        <div id="config-wizard-step-2" class="config-wizard-step" data-step="2">
          <h3>2. Device</h3>
          <div class="config-wizard-field">
            <label for="config-wizard-device">Device</label>
            <select id="config-wizard-device">
              <option value="">‚Äî Select device ‚Äî</option>
            </select>
          </div>
        </div>
        <div id="config-wizard-step-3" class="config-wizard-step" data-step="3">
          <h3>3. Firmware target</h3>
          <div class="config-wizard-field">
            <label for="config-wizard-firmware">Firmware (internal or Launcher)</label>
            <select id="config-wizard-firmware">
              <option value="">‚Äî Select firmware ‚Äî</option>
            </select>
          </div>
        </div>
        <div id="config-wizard-step-4" class="config-wizard-step" data-step="4">
          <h3>4. Options</h3>
          <div class="config-wizard-options">
            <div class="config-wizard-field">
              <label for="config-wizard-region">Region (RF)</label>
              <select id="config-wizard-region">
                <option value="">‚Äî Select region ‚Äî</option>
              </select>
            </div>
            <div class="config-wizard-field">
              <label for="config-wizard-device-name">Device name</label>
              <input type="text" id="config-wizard-device-name" placeholder="e.g. My T-Beam" autocomplete="off">
            </div>
            <div class="config-wizard-field">
              <label for="config-wizard-preset-name">Preset name (for saving)</label>
              <input type="text" id="config-wizard-preset-name" placeholder="e.g. home-usa" autocomplete="off">
            </div>
          </div>
        </div>
        <div id="config-wizard-step-5" class="config-wizard-step" data-step="5">
          <h3>5. Review &amp; apply</h3>
          <div id="config-wizard-review" class="config-wizard-review"></div>
          <div class="config-wizard-actions">
            <button type="button" id="config-wizard-save-preset" class="btn-refresh">Save preset</button>
            <button type="button" id="config-wizard-goto-flash" class="btn-refresh">Go to Backup / Flash</button>
          </div>
          <span id="config-wizard-result" class="flash-status" aria-live="polite"></span>
        </div>
        <div class="config-wizard-nav">
          <button type="button" id="config-wizard-prev" class="btn-refresh">Previous</button>
          <button type="button" id="config-wizard-next" class="btn-refresh">Next</button>
        </div>
      </div>
      <div class="config-wizard-ai">
        <h3 class="config-wizard-ai-heading">AI assist</h3>
        <p class="config-wizard-ai-note">Ask for help with region, device name, or any step. The AI sees your current wizard state.</p>
        <div id="config-wizard-ai-messages" class="config-wizard-ai-messages" aria-live="polite"></div>
        <div class="config-wizard-ai-input">
          <input type="text" id="config-wizard-ai-input" placeholder="e.g. Which region for USA? What TX power is safe?" autocomplete="off">
          <button type="button" id="config-wizard-ai-send">Ask</button>
        </div>
      </div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-debug" role="tabpanel" aria-labelledby="tab-btn-debug" hidden>
  <section class="debug-section" id="debug-section">
    <h2 class="debug-heading">Debug ‚Äî live device logs &amp; troubleshooting</h2>
    <p class="debug-note">Serial monitor shows live output from a connected device. Maintenance tools help diagnose port, esptool, and database issues. The AI (Setup help) has access to this context and will suggest fixes when problems are detected.</p>
    <div class="debug-serial-block">
      <h3 class="debug-subheading">Live device logs (serial monitor)</h3>
      <div class="debug-serial-controls">
        <label for="debug-serial-port">Port</label>
        <select id="debug-serial-port">
          <option value="">‚Äî Select port ‚Äî</option>
        </select>
        <label for="debug-serial-baud">Baud</label>
        <select id="debug-serial-baud">
          <option value="9600">9600</option>
          <option value="57600">57600</option>
          <option value="115200" selected>115200</option>
          <option value="230400">230400</option>
          <option value="460800">460800</option>
          <option value="921600">921600</option>
        </select>
        <button type="button" id="debug-serial-start" class="btn-refresh">Start</button>
        <button type="button" id="debug-serial-stop" class="btn-refresh">Stop</button>
        <button type="button" id="debug-serial-clear" class="btn-refresh">Clear</button>
        <span id="debug-serial-status" class="flash-status" aria-live="polite"></span>
      </div>
      <pre id="debug-serial-log" class="debug-serial-log" aria-label="Serial output"></pre>
    </div>
    <div class="debug-tools-block">
      <h3 class="debug-subheading">Maintenance &amp; troubleshooting</h3>
      <div class="debug-tools-actions">
        <button type="button" id="debug-tool-ports" class="btn-refresh">List ports</button>
        <button type="button" id="debug-tool-esptool" class="btn-refresh">Esptool version</button>
        <button type="button" id="debug-tool-health" class="btn-refresh">Run health check</button>
      </div>
      <div id="debug-tools-output" class="debug-tools-output" aria-live="polite"></div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-setup-help" role="tabpanel" aria-labelledby="tab-btn-setup-help" hidden>
  <section class="setup-help-section" id="setup-help-section">
    <h2 class="setup-help-heading">Setup help</h2>
    <p class="setup-help-note">Ask for setup recommendations, step-by-step wizard guidance, or what‚Äôs allowed in each area (paths, flash, map tiles, project planning, device registry, Docker). The AI can see your Debug tab context (serial logs, health) and will suggest fixes when problems are detected.</p>
    <div id="setup-help-problems-banner" class="setup-help-problems-banner" hidden aria-live="polite">
      <strong>Problems detected.</strong> <span id="setup-help-problems-text"></span>
      <button type="button" id="setup-help-ask-fixes" class="btn-refresh">Ask AI for suggestions</button>
    </div>
    <div class="setup-help-chat">
      <div id="setup-help-messages" class="project-messages" aria-live="polite"></div>
      <div class="project-chat-input">
        <input type="text" id="setup-help-message" placeholder="e.g. How do I set paths? What backup types are valid?" autocomplete="off">
        <button type="button" id="btn-setup-help-send">Send</button>
      </div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-add-device" role="tabpanel" aria-labelledby="tab-btn-add-device" hidden>
  <section class="add-device-section" id="add-device-section">
    <h2 class="add-device-heading">Add device wizard</h2>

    <div class="add-device-datasheet-block">
      <h3 class="add-device-datasheet-heading">Add from datasheet</h3>
      <p class="add-device-datasheet-note">Upload a PDF datasheet. The AI will extract dimensions, pinout, and layout, assign it to an existing inventory item if it matches, or suggest a new device. A design context file is written for the PCB/3D design AI.</p>
      <div id="datasheet-drop-zone" class="datasheet-drop-zone" role="button" tabindex="0" aria-label="Drop PDF here or click to browse">
        <input type="file" id="datasheet-file-input" accept=".pdf,application/pdf" hidden>
        <span id="datasheet-drop-text">Drop PDF here or <u>browse</u></span>
        <span id="datasheet-analyzing" class="datasheet-analyzing" hidden>Analyzing‚Ä¶</span>
      </div>
      <div id="datasheet-result" class="datasheet-result" hidden aria-live="polite"></div>
    </div>

    <p class="add-device-note">Or choose a device from the catalog (LilyGo, Heltec, Raspberry Pi, Pine64, Arduino, Teensy). Add documentation and firmware links; the wizard creates <code>devices/&lt;id&gt;/</code> and <code>registry/devices/</code> with the correct structure.</p>
    <div class="add-device-wizard">
      <div class="add-device-filters">
        <label for="device-wizard-vendor">Vendor</label>
        <select id="device-wizard-vendor">
          <option value="">All vendors</option>
        </select>
        <label for="device-wizard-search">Search</label>
        <input type="text" id="device-wizard-search" placeholder="Search by name, ID, MCU‚Ä¶" autocomplete="off">
        <label class="add-device-show-images-label">
          <input type="checkbox" id="device-wizard-show-images" autocomplete="off">
          Show device images
        </label>
      </div>
      <div class="add-device-list-preview">
        <div class="add-device-list-wrap">
          <div id="device-wizard-list" class="add-device-list" aria-live="polite"></div>
        </div>
        <div id="device-wizard-preview" class="add-device-preview" hidden aria-hidden="true">
          <div class="add-device-preview-card">
            <img id="device-wizard-preview-img" src="" alt="" role="presentation">
            <span id="device-wizard-preview-name" class="add-device-preview-name"></span>
          </div>
        </div>
      </div>
      <div id="device-wizard-form-wrap" class="add-device-form-wrap" hidden>
        <h3 class="add-device-form-heading">Create device structure</h3>
        <div class="add-device-form">
          <div class="settings-row">
            <label for="device-form-id">Device ID</label>
            <input type="text" id="device-form-id" placeholder="e.g. t_beam_1w" autocomplete="off">
          </div>
          <div class="settings-row">
            <label for="device-form-name">Name</label>
            <input type="text" id="device-form-name" placeholder="Display name" autocomplete="off">
          </div>
          <div class="settings-row">
            <label for="device-form-mcu">MCU</label>
            <input type="text" id="device-form-mcu" placeholder="e.g. ESP32-S3" autocomplete="off">
          </div>
          <div class="settings-row">
            <label for="device-form-datasheet">Datasheet URL</label>
            <input type="url" id="device-form-datasheet" placeholder="https://‚Ä¶" autocomplete="off">
          </div>
          <div class="settings-row">
            <label for="device-form-schematic">Schematic URL</label>
            <input type="url" id="device-form-schematic" placeholder="https://‚Ä¶" autocomplete="off">
          </div>
          <div class="settings-row">
            <label>Firmware repo URLs</label>
            <div id="device-form-firmware-repos">
              <input type="url" class="device-form-repo" placeholder="https://github.com/‚Ä¶" autocomplete="off">
            </div>
            <button type="button" id="device-form-add-repo" class="btn-refresh">Add another repo</button>
          </div>
          <div class="settings-row add-device-sdk-row" id="device-form-sdk-row" hidden>
            <label>
              <input type="checkbox" id="device-form-install-sdk" autocomplete="off" checked>
              Install device SDK (recommended)
            </label>
            <span class="add-device-sdk-hint" id="device-form-sdk-hint">PlatformIO platform will be installed so builds work for this device.</span>
          </div>
          <div class="settings-row add-device-inventory-row">
            <label>
              <input type="checkbox" id="device-form-add-to-inventory" autocomplete="off">
              Add to inventory catalog
            </label>
          </div>
          <div id="device-form-inventory-category-wrap" class="settings-row add-device-inventory-category" hidden>
            <label for="device-form-inventory-category">Inventory category</label>
            <select id="device-form-inventory-category">
              <option value="controller">Controller (MCU boards, dev kits)</option>
              <option value="sbc">SBC (Raspberry Pi, Pine64, etc.)</option>
              <option value="sensor">Sensor</option>
              <option value="accessory">Accessory</option>
              <option value="component">Component</option>
            </select>
          </div>
        </div>
        <div class="add-device-form-actions">
          <button type="button" id="device-form-submit" class="btn-refresh">Create device structure</button>
          <button type="button" id="device-form-cancel" class="btn-refresh">Cancel</button>
        </div>
        <div id="device-wizard-result" class="flash-status" aria-live="polite"></div>
      </div>
    </div>
  </section>
  </section>

  <section class="tab-panel" id="panel-inventory" role="tabpanel" aria-labelledby="tab-btn-inventory" hidden>
  <section class="inventory-filters">
    <input type="text" id="inventory-search" placeholder="Search‚Ä¶" autocomplete="off">
    <select id="inventory-category">
      <option value="">All categories</option>
    </select>
    <select id="inventory-manufacturer">
      <option value="">All manufacturers</option>
    </select>
    <button type="button" id="inventory-btn-apply">Apply</button>
  </section>
  <section class="results-header">
    <span id="results-count">‚Äî</span> items
  </section>

  <section class="table-wrap">
    <table class="inventory-table" id="inventory-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="name" title="Sort by name">Name</th>
          <th class="sortable" data-sort="category" title="Sort by category">Category</th>
          <th class="sortable" data-sort="quantity" title="Sort by quantity">Qty</th>
          <th class="sortable" data-sort="part_number" title="Sort by part number">Part #</th>
          <th class="sortable" data-sort="location" title="Sort by location">Location</th>
          <th class="sortable" data-sort="manufacturer" title="Sort by manufacturer">Manufacturer</th>
          <th>Datasheet</th>
        </tr>
      </thead>
      <tbody id="tbody">
      </tbody>
    </table>
  </section>
  </section>

  </div>

  <section class="detail-panel" id="detail-panel" hidden>
    <button type="button" class="close-detail" id="close-detail" aria-label="Close">√ó</button>
    <div id="detail-content"></div>
  </section>
{% endblock %}
{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
{% endblock %}
